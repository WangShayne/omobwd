---
name: do
description: 智能任务路由与执行监督，分发任务给合适的 agent，验证结果，处理失败
when_to_use: 当需要在 oh-my-opencode 中执行具体任务时
version: 1.3.0
---

# Do - 智能任务执行器

接收用户任务，路由到合适的执行者（agent/skill/tool），监督执行过程，验证结果，处理失败。

## 核心能力

```
┌─────────────────────────────────────────────────┐
│                  omobwd:do                       │
├─────────────────────────────────────────────────┤
│  1. 意图解析 - 理解用户要做什么                    │
│  2. 路由决策 - 选择合适的 agent/skill             │
│  3. 任务分发 - 并行或串行调度执行                  │
│  4. 结果验证 - 检查输出是否符合预期                │
│  5. 失败处理 - 重试、降级、或上报用户              │
│  6. 进度追踪 - 通过 todo 保持可见性               │
└─────────────────────────────────────────────────┘
```

## 流程

### 1. 意图解析

分析用户请求，判断：
- 任务是否足够清晰？
- 需要什么能力来完成？
- 是单步还是多步任务？
- 有无依赖关系？

如果任务不清晰，调用 `omobwd:brainstorming` 澄清。

### 2. 路由决策

根据任务类型选择执行者：

| 任务类型 | 路由目标 | 示例 |
|----------|----------|------|
| 需要澄清需求 | `omobwd:brainstorming` | "我想加个功能但还没想好" |
| 需要创建文档 | `omobwd:write-docs` | "帮我写个技能文件" |
| 代码探索 | `explore` agent | "找到处理认证的代码" |
| 外部文档查询 | `librarian` agent | "查一下这个库怎么用" |
| 架构决策 | `oracle` agent | "这两种方案哪个好" |
| UI/样式修改 | `frontend-ui-ux-engineer` | "改一下按钮颜色" |
| 文档编写 | `document-writer` | "写个 README" |
| 开发任务 | 询问是否使用 ultrawork | "实现这个功能" |
| 直接执行 | 内置工具 | "运行测试" |

### 3. 任务分发

**开发任务执行前询问**：

当任务需要实际编码/开发执行时，询问用户：

> 需要执行开发任务。是否使用 oh-my-opencode 的 ultrawork 模式来执行？
> A) 是 - 使用 ultrawork 执行
> B) 否 - 当前 agent 直接执行

根据用户选择：
- A → 使用 ultrawork 模式执行（见下方说明）
- B → 使用内置工具或 agents 直接执行

**Ultrawork 模式调用方式**：

ultrawork 不是斜杠命令，而是 oh-my-opencode 的关键词触发模式。

**重要**：当用户选择 ultrawork 模式时，必须**立即开始执行任务**，而不是只输出带 `ulw` 的文本。

正确的执行方式：
1. 在后续的工作消息中，以 `ulw` 关键词开头
2. **立即开始实际的开发工作**：创建文件、编写代码、运行命令
3. oh-my-opencode 的 keyword-detector hook 会检测到关键词并激活高强度模式

错误的方式（不要这样做）：
```
# 错误：只输出文本，不执行任何操作
ulw 根据设计文档实现功能...
（然后什么都不做）
```

正确的方式：
```
ulw 开始实现功能

（立即开始执行）
1. 创建 todo list
2. 使用 Write 工具创建第一个文件
3. 继续执行后续步骤...
```

**单步任务**：直接调用目标执行者

**多步任务**：
1. 创建 todo list 追踪进度
2. 分析步骤间依赖关系
3. 独立步骤并行执行（background_task）
4. 依赖步骤串行执行
5. 每步完成后更新 todo 状态

### 4. 结果验证

每个子任务完成后验证：

| 任务类型 | 验证方式 |
|----------|----------|
| 代码修改 | `lsp_diagnostics` 无错误 |
| 构建任务 | exit code = 0 |
| 测试任务 | 测试通过 |
| 文件生成 | 文件存在且格式正确 |

**无证据 = 未完成**

### 5. 失败处理

```
失败 → 分析原因
       │
       ├── 可重试错误（网络、临时失败）
       │   └── 重试，最多 2 次
       │
       ├── 需要更多信息
       │   └── 询问用户
       │
       ├── agent 能力不足
       │   └── 升级到 oracle
       │
       └── 根本性问题
           └── 停止并报告
            └── 建议调用 brainstorming 重新思考
```

### 6. 进度追踪

- 多步任务必须创建 todo list
- 开始步骤前标记 `in_progress`
- 完成后立即标记 `completed`
- 同时只有一个步骤 `in_progress`

## 监督原则

1. **验证优先** - 每步完成后必须验证
2. **快速失败** - 发现问题立即处理，不积累
3. **透明进度** - 用户随时可见当前状态
4. **保守重试** - 只对瞬时错误重试，不盲目循环

## 示例

### 简单任务

```
用户：运行测试

do：
  1. 识别：直接执行任务
  2. 执行：bash npm test
  3. 验证：exit code = 0
  4. 报告：测试通过/失败
```

### 复杂任务

```
用户：帮我创建一个 git hook 技能

do：
  1. 识别：需要创建文档，可能需要先澄清
  2. 询问：这个技能的主要功能是什么？
     - A) commit message 格式化
     - B) pre-commit 代码检查
     - C) 其他
  3. 用户选择后，调用 omobwd:write-docs
  4. 验证：SKILL.md 格式正确
  5. 报告：技能文件已创建
```

### 链式任务

```
用户：从头开始做一个代码格式化技能

do：
  1. 识别：需要完整流程
  2. 调用 omobwd:brainstorming 澄清需求
  3. brainstorming 完成后，调用 omobwd:write-docs 生成文件
  4. 验证文件格式
  5. 报告完成
```

## 与其他技能的关系

- 可调用 `omobwd:brainstorming` 澄清需求
- 可调用 `omobwd:write-docs` 生成文档
- 可调用所有 oh-my-opencode agents
- 可通过 `ulw` 关键词触发 ultrawork 模式执行开发任务
- 是其他技能的编排入口
